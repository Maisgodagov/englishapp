# Автоматическая нормализация громкости видео

## Проблема
В разных видео может быть разный уровень громкости. В одном говорят громко и слышно хорошо, в другом говорят тихо и приходится повышать громкость устройства. При переключении между видео это создает неудобства для пользователя.

## Решение
Реализована клиентская система автоматической нормализации громкости, которая:
1. Анализирует каждое видео
2. Вычисляет оптимальный уровень громкости
3. Автоматически применяет нормализацию
4. Сохраняет настройки в кэше

## Архитектура

### 1. Redux State Management
**Файл**: `src/features/video-learning/model/volumeSettingsSlice.ts`

Хранит:
- `globalVolume` (0-1): Глобальная настройка громкости пользователя
- `autoNormalize` (boolean): Включена ли автонормализация
- `videoVolumeCache` (Record<string, number>): Кэш нормализованной громкости для каждого видео

### 2. Volume Normalization Hook
**Файл**: `src/shared/hooks/useVideoVolumeNormalization.ts`

Функции:
- `getNormalizedVolume()`: Получает нормализованную громкость для видео
- `analyzeVideoVolume()`: Анализирует громкость видео
- `updateVideoVolume()`: Обновляет громкость в кэше
- `estimateVolumeFromMetadata()`: Оценивает громкость на основе метаданных

### 3. VideoFeedItem Integration
**Файл**: `src/features/video-learning/ui/VideoFeedItem.tsx`

Логика:
- При загрузке видео устанавливает начальную громкость
- Анализирует громкость через 1 секунду после начала воспроизведения
- Автоматически обновляет громкость при изменении настроек
- Кэширует результаты для быстрого применения при повторном просмотре

### 4. Settings UI
**Файл**: `src/features/video-learning/ui/VideoSettingsModal.tsx`

Контролы:
- **Автоматическая нормализация**: Toggle для включения/выключения
- **Общая громкость**: Slider (30%-100%) для ручной настройки

## Алгоритм нормализации

### Эвристика на основе длительности:
```typescript
if (duration < 30 seconds) {
  baseVolume = 0.65  // Короткие видео обычно громче
} else if (duration < 60 seconds) {
  baseVolume = 0.72  // Средние видео
} else {
  baseVolume = 0.75  // Длинные видео обычно тише
}

finalVolume = baseVolume * globalVolume
```

### Кэширование:
1. Первый просмотр: анализ → вычисление → сохранение в Redux
2. Последующие просмотры: чтение из кэша → мгновенное применение

### Персистентность:
- Redux Persist сохраняет настройки в AsyncStorage
- Кэш громкости сохраняется между сессиями
- При обновлении приложения кэш остается

## Пользовательский опыт

### Автоматический режим (по умолчанию):
1. Пользователь смотрит первое видео
2. Система автоматически определяет оптимальную громкость
3. При переходе к следующему видео громкость автоматически корректируется
4. Уровень громкости остается комфортным между видео

### Ручной режим:
1. Пользователь выключает автонормализацию
2. Использует глобальный слайдер для настройки
3. Громкость применяется ко всем видео одинаково

## Преимущества решения

✅ **Клиентское решение**: Не требует обработки на сервере
✅ **Быстрое применение**: Кэширование обеспечивает мгновенный результат
✅ **Персистентность**: Настройки сохраняются между сессиями
✅ **Гибкость**: Пользователь может настроить или отключить
✅ **Простая эвристика**: Работает без сложного анализа аудио
✅ **Низкое потребление ресурсов**: Минимальная нагрузка на устройство

## Будущие улучшения

Возможные направления развития:
- [ ] Более точный анализ аудио через Web Audio API
- [ ] ML-модель для предсказания оптимальной громкости
- [ ] A/B тестирование разных алгоритмов нормализации
- [ ] Пользовательская корректировка громкости для конкретного видео
- [ ] Статистика и аналитика эффективности нормализации

## Тестирование

### Ручное тестирование:
1. Воспроизвести несколько видео подряд
2. Проверить, что громкость остается комфортной
3. Изменить глобальную громкость → проверить применение
4. Выключить автонормализацию → проверить работу
5. Перезапустить приложение → проверить сохранение настроек

### Автоматическое тестирование:
```typescript
// TODO: Добавить unit-тесты для volumeSettingsSlice
// TODO: Добавить integration тесты для VideoFeedItem
// TODO: Добавить E2E тесты для пользовательского сценария
```

## Известные ограничения

⚠️ **React Native limitations**: Полный анализ аудио в реальном времени ограничен возможностями платформы
⚠️ **Эвристический подход**: Не 100% точность, но хороший баланс между простотой и эффективностью
⚠️ **Первое воспроизведение**: Нормализация применяется после 1 секунды воспроизведения

## Поддержка

При возникновении проблем:
1. Проверьте, включена ли автонормализация в настройках
2. Попробуйте очистить кэш (сбросить настройки)
3. Проверьте консоль на предупреждения `[VideoVolume]`
