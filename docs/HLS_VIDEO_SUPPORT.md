# Поддержка HLS видео-потоков

## Описание

Наше приложение использует HLS (HTTP Live Streaming) для потоковой передачи видео. Бэкенд автоматически конвертирует загруженные видео в HLS формат с несколькими разрешениями.

## Архитектура на бэкенде

### Структура хранения

После обработки видео создается следующая структура в S3/CDN:

```
videos/<safeBaseName>/
├── master.m3u8          # Мастер-плейлист (главный файл)
├── 720p.m3u8           # Плейлист для 720p
├── 480p.m3u8           # Плейлист для 480p
├── 360p.m3u8           # Плейлист для 360p
├── 720p_000.ts         # Сегменты для 720p
├── 720p_001.ts
├── 480p_000.ts         # Сегменты для 480p
├── 480p_001.ts
└── ...
```

### Формат videoUrl

Поле `videoUrl` в базе данных содержит URL мастер-плейлиста:

```
https://<cdn>/videos/<safeBaseName>/master.m3u8
```

- `<safeBaseName>` - автоматически генерируемый уникальный идентификатор
- Приложение использует этот URL напрямую
- Плеер автоматически выбирает оптимальное разрешение на основе скорости соединения

### MP4 Fallback (опционально)

В настоящее время `includeMp4Fallback = false`, поэтому хранится только HLS.
Если в будущем включить эту опцию, MP4 будет доступен отдельно, но основной URL останется на `.m3u8`.

## Реализация на фронтенде

### Библиотека

Используется `expo-video` (версия 3.0.12+), которая нативно поддерживает HLS на всех платформах:
- **iOS**: AVPlayer (нативная поддержка HLS)
- **Android**: ExoPlayer (нативная поддержка HLS)
- **Web**: HLS.js или нативная поддержка в браузере

### Использование

Для правильной работы HLS необходимо явно указывать `contentType: 'hls'`:

```typescript
const player = useVideoPlayer(
  {
    uri: content.videoUrl,
    ...(content.videoUrl.includes('.m3u8') && { contentType: 'hls' as const }),
  },
  (player) => {
    player.loop = true;
    player.volume = 1.0;
  }
);
```

### Компоненты с поддержкой HLS

1. **VideoFeedItem** (`src/features/video-learning/ui/VideoFeedItem.tsx`)
   - Основной компонент для просмотра видео в ленте
   - Поддерживает автоматическое воспроизведение, паузу, перемотку

2. **VideoLearningSession** (`src/features/video-learning/ui/VideoLearningSession.tsx`)
   - Сессия обучения с видео и упражнениями
   - Поддерживает воспроизведение сегментов

3. **PhraseSearch** (`src/features/video-learning/ui/PhraseSearch.tsx`)
   - Поиск фраз в видео
   - Воспроизведение конкретных временных отрезков

## Преимущества HLS

1. **Adaptive Bitrate Streaming (ABR)**
   - Автоматическое переключение между разрешениями в зависимости от скорости соединения
   - Плавное воспроизведение даже при слабом интернете

2. **Оптимизация загрузки**
   - Видео разбито на сегменты (~6 секунд)
   - Загружаются только необходимые сегменты
   - Быстрый старт воспроизведения

3. **Масштабируемость**
   - CDN эффективно кэширует сегменты
   - Снижение нагрузки на сервер

4. **Кросс-платформенность**
   - Работает одинаково на iOS, Android, Web
   - Не требует специальных кодеков

## Тестирование

### Проверка работы HLS

1. Убедитесь, что `videoUrl` содержит `.m3u8`
2. Откройте видео в приложении
3. Проверьте, что:
   - Видео загружается и воспроизводится
   - Переключение качества происходит автоматически (можно проверить, меняя скорость сети)
   - Перемотка работает корректно
   - Буферизация минимальна

### Отладка

Если видео не воспроизводится:

1. Проверьте URL в консоли - должен заканчиваться на `.m3u8`
2. Откройте URL в браузере - должен показать текстовый плейлист
3. Проверьте доступность CDN
4. Убедитесь, что `contentType: 'hls'` указан в коде

### Пример валидного HLS URL

```
https://cdn.example.com/videos/abc123-def456/master.m3u8
```

## Полезные ссылки

- [expo-video документация](https://docs.expo.dev/versions/latest/sdk/video/)
- [HLS спецификация](https://developer.apple.com/documentation/http-live-streaming)
- [Adaptive Bitrate Streaming](https://en.wikipedia.org/wiki/Adaptive_bitrate_streaming)
